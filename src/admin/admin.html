<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理后台 - 35短链接服务</title>
  <style>
    body {margin:0;font-family:sans-serif;background:#f5f6fa;}
    .sidebar {position:fixed;left:0;top:0;bottom:0;width:220px;background:#1976d2;color:#fff;display:flex;flex-direction:column;z-index:10;}
    .sidebar h2 {margin:0;padding:28px 0 18px 0;text-align:center;font-size:22px;letter-spacing:2px;}
    .nav {flex:1;display:flex;flex-direction:column;}
    .nav a {padding:16px 32px;color:#fff;text-decoration:none;transition:background 0.2s;font-size:16px;}
    .nav a.active,.nav a:hover {background:#1565c0;}
    .main {margin-left:220px;padding:32px 24px;min-height:100vh;transition:margin 0.2s;}
    @media (max-width:700px) {
      .sidebar {position:relative;width:100%;flex-direction:row;height:auto;}
      .sidebar h2 {display:none;}
      .nav {flex-direction:row;}
      .nav a {flex:1;padding:12px 0;text-align:center;}
      .main {margin-left:0;padding:18px 4px;}
    }
    .section {display:none;}
    .section.active {display:block;}
    .table {width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .table th,.table td {padding:12px 8px;border-bottom:1px solid #f0f0f0;text-align:left;}
    .table th {background:#f5f6fa;}
    .table tr:last-child td {border-bottom:none;}
    .btn {padding:6px 16px;background:#1976d2;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px #dbeafe;position:relative;overflow:hidden;}
    .btn:active {background:#1565c0;transform:scale(0.97);}
    .btn:disabled {background:#bcd0f7;color:#fff;cursor:not-allowed;opacity:0.7;}
    .actions .btn {min-width:60px;}
    .input {padding:6px 10px;border:1px solid #ddd;border-radius:4px;transition:border 0.2s,box-shadow 0.2s;}
    .input:focus {border:1.5px solid #1976d2;box-shadow:0 0 0 2px #dbeafe;}
    .form-group label {font-weight:500;margin-bottom:4px;}
    .form-group input[type="text"],.form-group input[type="number"] {width:100%;}
    .modal-content {background:#fff;padding:28px 22px 18px 22px;border-radius:12px;box-shadow:0 4px 24px #0002;min-width:320px;max-width:96vw;animation:fadeIn 0.4s;}
    @keyframes fadeIn {from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    @media (max-width:700px) {.modal-content{min-width:90vw;padding:14px 4vw 12px 4vw;}}
    .actions {display:flex;gap:8px;}
    .title-bar {display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .title-bar h3 {margin:0;font-size:20px;}
    .form-inline {display:flex;gap:10px;align-items:center;margin-bottom:16px;}
    .stat-box {display:inline-block;background:#fff;padding:18px 28px;margin:0 12px 18px 0;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);min-width:120px;text-align:center;}
    .stat-box strong {font-size:22px;display:block;margin-bottom:6px;}
    .empty-tip {color:#888;text-align:center;padding:32px 0;}
  </style>
</head>
<body>
<script>
// 检查管理员登录cookie，未登录则跳转到登录页
(function(){
  function getCookie(name) {
    var arr = document.cookie.match(new RegExp('(?:^| )'+name+'=([^;]*)'));
    return arr ? decodeURIComponent(arr[1]) : null;
  }
  var user = getCookie('user');
  var password = getCookie('password');
  if(!user || !password){
    window.location.href = '/admin/login';
  }
})();
</script>
  <div class="sidebar">
    <h2>管理后台</h2>
    <nav class="nav">
      <a href="#" class="active" data-section="shortlink">短链管理</a>
      <a href="#" data-section="stats">统计</a>
      <a href="#" data-section="blacklist">黑名单管理</a>
      <a href="#" data-section="whitelist">白名单管理</a>
      <a href="#" data-section="log">操作日志</a>
     <a href="#" data-section="friendlink">友情链接管理</a>
     <a href="#" data-section="setting">系统设置</a>
    </nav>
  </div>
  <div class="main">
    <!-- 短链管理 -->
    <section class="section active" id="section-shortlink">
      <div class="title-bar">
        <h3>短链管理</h3>
        <button class="btn" onclick="loadShortlinks()">刷新</button>
        <button class="btn" onclick="showAddShortlink()">新增短链</button>
      </div>
      <div class="form-inline">
        <input class="input" id="searchShortlink" placeholder="搜索短链/原始链接...">
        <button class="btn" onclick="searchShortlink()">搜索</button>
      </div>
      <table class="table" id="shortlinkTable">
        <thead>
          <tr><th>短链</th><th>原始链接</th><th>创建时间</th><th>访问量</th><th>到期时间</th><th>有效期</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="empty-tip" id="shortlinkEmpty" style="display:none;">暂无短链数据</div>
    </section>
    <!-- 统计 -->
    <section class="section" id="section-stats">
      <div class="title-bar"><h3>访问统计</h3><button class="btn" onclick="loadStats()">刷新</button></div>
      <div id="statsBoxes">
        <div class="stat-box"><strong id="statTotal">0</strong>总短链数</div>
        <div class="stat-box"><strong id="statVisit">0</strong>总访问量</div>
        <div class="stat-box"><strong id="statToday">0</strong>今日访问量</div>
      </div>
      <table class="table" id="statsTable">
        <thead><tr><th>短链</th><th>访问量</th><th>最后访问</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="empty-tip" id="statsEmpty" style="display:none;">暂无统计数据</div>
    </section>
    <!-- 黑名单管理 -->
    <section class="section" id="section-blacklist">
      <div class="title-bar">
        <h3>黑名单管理</h3>
        <button class="btn" onclick="loadBlacklist()">刷新</button>
        <button class="btn" onclick="showAddBlacklist()">新增黑名单</button>
        <button class="btn" onclick="showImportBlacklist()">批量导入</button>
        <button class="btn" onclick="exportBlacklist()">导出</button>
      </div>
      <table class="table" id="blacklistTable">
        <thead><tr><th>域名/关键词</th><th>添加时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="empty-tip" id="blacklistEmpty" style="display:none;">暂无黑名单数据</div>
    </section>
    <!-- 白名单管理 -->
    <section class="section" id="section-whitelist">
      <div class="title-bar">
        <h3>白名单管理</h3>
        <button class="btn" onclick="loadWhitelist()">刷新</button>
        <button class="btn" onclick="showAddWhitelist()">新增白名单</button>
        <button class="btn" onclick="showImportWhitelist()">批量导入</button>
        <button class="btn" onclick="exportWhitelist()">导出</button>
      </div>
      <div style="margin-bottom:12px;color:#1976d2;font-size:15px;">
        <b>说明：</b>白名单内域名跳转时将不做延时，直接跳转。可用于配置“直跳白名单”域名。
      </div>
      <table class="table" id="whitelistTable">
        <thead><tr><th>域名</th><th>添加时间</th><th>操作</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="empty-tip" id="whitelistEmpty" style="display:none;">暂无白名单数据</div>
    </section>
    <section class="section" id="section-log">
      <h2>操作日志</h2>
      <div style="margin-bottom:12px;">
        <label>起始日期：<input type="date" id="logStartDate"></label>
        <label>结束日期：<input type="date" id="logEndDate"></label>
        <label>类型：<select id="logType"><option value="">全部</option><option value="新增短链">新增短链</option><option value="修改短链">修改短链</option><option value="删除短链">删除短链</option><option value="添加黑名单">添加黑名单</option><option value="移除黑名单">移除黑名单</option><option value="添加白名单">添加白名单</option><option value="移除白名单">移除白名单</option></select></label>
        <button class="btn" onclick="loadAdminLogs()">查询</button>
        <button class="btn" style="background:#e53935;margin-left:8px;" onclick="clearAllAdminLogs()">全部清除</button>
      </div>
      <table class="table" id="logTable">
        <thead><tr><th>时间</th><th>类型</th><th>详情</th><th>操作者</th><th>IP</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="logEmpty" class="empty-tip" style="display:none;">暂无日志</div>
      <div id="logPager" style="margin-top:12px;text-align:right;"></div>
    </section>
       <!-- 友情链接管理 -->
   <section class="section" id="section-friendlink">
    <div class="title-bar"><h3>友情链接管理</h3><button class="btn" onclick="loadFriendLinks()">刷新</button><button class="btn" onclick="showAddFriendLink()">新增</button></div>
    <table class="table" id="friendlinkTable">
      <thead><tr><th>名称</th><th>URL</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="empty-tip" id="friendlinkEmpty" style="display:none;">暂无友情链接</div>
  </section>
  <!-- 系统设置 -->
  <section class="section" id="section-setting">
    <div class="title-bar"><h3>系统设置</h3><button class="btn" onclick="saveCopyright()">保存</button></div>
    <div class="form-group">
      <label for="copyrightInput">版权信息</label>
      <input class="input" id="copyrightInput" type="text" placeholder="请输入版权信息">
    </div>
  </section>
  </div>

  <!-- 弹窗区 -->
  <div id="modal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:99;align-items:center;justify-content:center;"></div>
  <script>
    // 侧边栏导航切换
    document.querySelectorAll('.nav a').forEach(function(nav){
      nav.onclick=function(e){
        e.preventDefault();
        document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
        nav.classList.add('active');
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById('section-'+nav.dataset.section).classList.add('active');
      };
    });
    // 数据加载（示例，需对接API）
    async function loadShortlinks(){
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/links', {headers: {Authorization: token}});
      const resp = await res.json();
      let data = [];
      if(resp && resp.status === 1 && Array.isArray(resp.data)){
        data = resp.data;
      }
      const tbody = document.querySelector('#shortlinkTable tbody');
      tbody.innerHTML = '';
      if (data && data.length) {
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.code}</td><td>${item.longUrl}</td><td>${item.created ? new Date(item.created).toLocaleString() : ''}</td><td>${item.visits||0}</td><td>${item.expire ? formatExpire(item.expire) : '--'}</td><td>${
            (function(){
            if(item.expire){
              var now=Date.now();
              var days=Math.ceil((item.expire-now)/86400000);
              return days>=365?'365天':(days>0?'剩余'+days+'天':'已过期');
            }else{
              return '永久';
            }
          })()
          }</td><td class='actions'>
            <button class='btn' onclick='editShortlink(${JSON.stringify(item)})'>编辑</button>
            <button class='btn' style='background:#e53935;' onclick='deleteShortlink("${item.code}")'>删除</button></td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('shortlinkEmpty').style.display = 'none';
      } else {
        document.getElementById('shortlinkEmpty').style.display = 'block';
      }
    }
    async function searchShortlink(){
      const token = localStorage.getItem('admin_token') || '';
      const kw = document.getElementById('searchShortlink').value.trim();
      const res = await fetch('/admin/api/links?kw='+encodeURIComponent(kw), {headers: {Authorization: token}});
      const resp = await res.json();
      let data = [];
      if(resp && resp.status === 1 && Array.isArray(resp.data)){
        data = resp.data;
      }
      const tbody = document.querySelector('#shortlinkTable tbody');
      tbody.innerHTML = '';
      if (data && data.length) {
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.code}</td><td>${item.longUrl}</td><td>${item.created ? new Date(item.created).toLocaleString() : ''}</td><td>${item.count||0}</td><td class='actions'>
            <button class='btn' onclick='editShortlink("${item.code}")'>编辑</button>
            <button class='btn' style='background:#e53935;' onclick='deleteShortlink("${item.code}")'>删除</button>
          </td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('shortlinkEmpty').style.display = 'none';
      } else {
        document.getElementById('shortlinkEmpty').style.display = 'block';
      }
    }
    function showAddShortlink(){
      showModal('新增短链',`<form id='addShortlinkForm' style='display:flex;flex-direction:column;gap:16px;'>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>原始链接 <span style='color:#e53935;'>*</span></label>
          <input class='input' name='url' required placeholder='请输入需要缩短的原始链接'>
          <small style='color:#888;font-size:13px;margin-top:2px;'>支持http/https开头的有效链接</small>
        </div>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>自定义短链(可选)</label>
          <input class='input' name='custom' placeholder='6-12位字母或数字'>
          <small style='color:#888;font-size:13px;margin-top:2px;'>如不填写则自动生成</small>
        </div>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>有效期(天)</label>
          <input class='input' name='expireDays' type='number' min='0' max='365' value='30'>
          <small style='color:#888;font-size:13px;margin-top:2px;'>1-365天，0为永久</small>
        </div>
        <div class='form-group' style='display:flex;gap:18px;'>
          <label style='font-weight:normal;'><input type='checkbox' name='delay3s' checked style='margin-right:6px;'> 跳转延时3秒</label>
        </div>
        <div style='display:flex;gap:12px;justify-content:flex-end;margin-top:8px;'>
          <button class='btn' type='submit' style='min-width:80px;'>提交</button>
          <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
        </div>
      </form>`);
      setTimeout(()=>{
        const form = document.getElementById('addShortlinkForm');
        if(form){
          form.onsubmit = async function(e){
            e.preventDefault();
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = '提交中...';
            const expireDays = parseInt(form.expireDays.value,10);
            let expire = 0;
            if(!isNaN(expireDays)){
              if(expireDays === 0){
                expire = 0;
              }else if(expireDays > 0){
                expire = Date.now() + expireDays*86400000;
              }
            }
            const body = {
              url: form.url.value.trim(),
              custom: form.custom.value.trim(),
              expire,
              delay: form.delay3s.checked
            };
            if(!body.url){alert('请输入原始链接');btn.disabled=false;btn.textContent='提交';return;}
            if(body.custom && !/^[a-zA-Z0-9]{6,12}$/.test(body.custom)){
              alert('自定义短链需为6-12位字母或数字');btn.disabled=false;btn.textContent='提交';return;}
            const token = localStorage.getItem('admin_token')||'';
            const res = await fetch('/admin/api/links', {method:'POST',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify(body)});
            const data = await res.json();
            if(data.status===1){alert('添加成功');closeModal();loadShortlinks();}else{alert(data.msg||'添加失败');}
            btn.disabled = false;
            btn.textContent = '提交';
          };
        }
      },100);
    }
    function editShortlink(item){
      showModal('编辑短链',`<form id='editShortlinkForm' style='display:flex;flex-direction:column;gap:16px;'>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>短链码 <span style='color:#e53935;'>*</span></label>
          <input class='input' name='newCode' value='${item.code}' required pattern='[a-zA-Z0-9]{6,12}' placeholder='请输入6-12位短链码'>
        </div>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>原始链接 <span style='color:#e53935;'>*</span></label>
          <input class='input' name='longUrl' value='${item.longUrl||""}' required placeholder='请输入需要缩短的原始链接'>
        </div>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>有效期(天)</label>
          <input class='input' name='expireDays' type='number' min='0' max='365' value='${item.expire===0?"0":Math.max(1,Math.ceil((item.expire-Date.now())/86400000))}'>
          <small style='color:#888;font-size:13px;margin-top:2px;'>0为永久</small>
        </div>
        <div class='form-group' style='display:flex;gap:18px;'>
          <label style='font-weight:normal;'><input type='checkbox' name='delay' ${item.delay!==false?'checked':''} style='margin-right:6px;'> 跳转延时3秒</label>
        </div>
        <div style='display:flex;gap:12px;justify-content:flex-end;margin-top:8px;'>
          <button class='btn' type='submit' style='min-width:80px;'>保存</button>
          <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
        </div>
      </form>`);
      document.getElementById('editShortlinkForm').onsubmit=async function(e){
        e.preventDefault();
        const token = localStorage.getItem('admin_token') || '';
        const form = e.target;
        const code = item.code;
        const newCode = form.newCode.value.trim();
        const longUrl = form.longUrl.value.trim();
        const expireDays = parseInt(form.expireDays.value,10);
        const delay = form.delay.checked;
        if(!newCode||!/^[a-zA-Z0-9]{6,12}$/.test(newCode)){alert('短链码需为6-12位字母或数字');return;}
        if(!longUrl){alert('请输入原始链接');return;}
        let expire = 0;
        if(!isNaN(expireDays)&&expireDays>0){expire = Date.now() + expireDays*86400000;}
        const body = { newCode, longUrl, expire, delay };
        const res = await fetch('/admin/api/links/'+encodeURIComponent(code), {method:'PUT',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify(body)});
        const data = await res.json();
        if(data.status===1){alert('修改成功');closeModal();loadShortlinks();}else{alert(data.msg||'修改失败');}
      };
    }
    async function deleteShortlink(short){
      if(!confirm('确定要删除该短链吗？'))return;
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/links/'+encodeURIComponent(short), {method:'DELETE',headers:{Authorization:token}});
      const data = await res.json();
      if(data.status===0){
        alert('删除成功');
        // 优化：前端直接移除对应短链行，无需整体刷新
        const tbody = document.querySelector('#shortlinkTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        let found = false;
        rows.forEach(tr => {
          if(tr.children[0] && tr.children[0].textContent === short){
            tbody.removeChild(tr);
            found = true;
          }
        });
        // 若删除后无数据，显示空提示
        if(tbody.children.length === 0){
          document.getElementById('shortlinkEmpty').style.display = 'block';
        }
      }else{
        alert(data.msg||'删除失败');
      }
    }
    // 统计数据加载
    async function loadStats(){
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/stats', {headers: {Authorization: token}});
      const resp = await res.json();
      let data = [];
      if(resp && resp.status === 1 && Array.isArray(resp.stats)){
        data = resp.stats;
      }
      const tbody = document.querySelector('#statsTable tbody');
      tbody.innerHTML = '';
      if (data && data.length) {
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.code}</td><td>${item.visits||0}</td><td>${item.lastVisit ? new Date(item.lastVisit).toLocaleString() : ''}</td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('statsEmpty').style.display = 'none';
      } else {
        document.getElementById('statsEmpty').style.display = 'block';
      }
      // 更新统计盒子
      document.getElementById('statTotal').textContent = resp.totalLinks || 0;
      document.getElementById('statVisit').textContent = resp.totalVisits || 0;
      document.getElementById('statToday').textContent = resp.todayVisits || 0;
    }
    async function loadBlacklist(){
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/blacklist', {headers: {Authorization: token}});
      const resp = await res.json();
      let data = [];
      if(resp && resp.status === 1 && Array.isArray(resp.data)){
        data = resp.data;
      }
      const tbody = document.querySelector('#blacklistTable tbody');
      tbody.innerHTML = '';
      if (data && data.length) {
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${typeof item === 'string' ? item : item.value}</td><td>${item.created ? new Date(item.created).toLocaleString() : ''}</td><td class='actions'><button class='btn' onclick='editBlacklist("${typeof item === 'string' ? item : item.value}",${JSON.stringify(item)})'>编辑</button> <button class='btn' style='background:#e53935;' onclick='deleteBlacklist("${typeof item === 'string' ? item : item.value}")'>删除</button></td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('blacklistEmpty').style.display = 'none';
      } else {
        document.getElementById('blacklistEmpty').style.display = 'block';
      }
    }
    async function loadWhitelist(){
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/whitelist', {headers: {Authorization: token}});
      const resp = await res.json();
      let data = [];
      if(resp && resp.status === 1 && Array.isArray(resp.data)){
        data = resp.data;
      }
      const tbody = document.querySelector('#whitelistTable tbody');
      tbody.innerHTML = '';
      if (data && data.length) {
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.value}</td><td>${item.created ? new Date(item.created).toLocaleString() : ''}</td><td class='actions'><button class='btn' onclick='editWhitelist("${item.value}",${JSON.stringify(item)})'>编辑</button> <button class='btn' style='background:#e53935;' onclick='deleteWhitelist("${item.value}")'>删除</button></td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('whitelistEmpty').style.display = 'none';
      } else {
        document.getElementById('whitelistEmpty').style.display = 'block';
      }
    }
    function showAddBlacklist(){
      showModal('新增黑名单',`<form id='addBlacklistForm'>
        <div class='form-group'><label>域名/关键词</label><input class='input' name='item' required></div>
        <button class='btn' type='submit'>提交</button>
      </form>`);
      document.getElementById('addBlacklistForm').onsubmit=async function(e){
        e.preventDefault();
        const token = localStorage.getItem('admin_token') || '';
        const form = e.target;
        const body = {item: form.item.value};
        const res = await fetch('/admin/api/blacklist', {method:'POST',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify(body)});
        const data = await res.json();
        if(data.status===0){alert('添加成功');closeModal();loadBlacklist();}else{alert(data.msg||'添加失败');}
      };
    }
    async function deleteBlacklist(item){
      if(!confirm('确定要删除该黑名单项吗？'))return;
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/blacklist/'+encodeURIComponent(item), {method:'DELETE',headers:{Authorization:token}});
      const data = await res.json();
      if(data.status===0){alert('删除成功');loadBlacklist();}else{alert(data.msg||'删除失败');}
    }
    function showAddWhitelist(){
      showModal('新增白名单',`<form id='addWhitelistForm'>
        <div class='form-group'><label>域名</label><input class='input' name='item' required></div>
        <button class='btn' type='submit'>提交</button>
      </form>`);
      document.getElementById('addWhitelistForm').onsubmit=async function(e){
        e.preventDefault();
        const token = localStorage.getItem('admin_token') || '';
        const form = e.target;
        const body = {item: form.item.value};
        const res = await fetch('/admin/api/whitelist', {method:'POST',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify(body)});
        const data = await res.json();
        if(data.status===0){alert('添加成功');closeModal();loadWhitelist();}else{alert(data.msg||'添加失败');}
      };
    }
    async function deleteWhitelist(item){
      if(!confirm('确定要删除该白名单项吗？'))return;
      const token = localStorage.getItem('admin_token') || '';
      const res = await fetch('/admin/api/whitelist/'+encodeURIComponent(item), {method:'DELETE',headers:{Authorization:token}});
      const data = await res.json();
      if(data.status===0){alert('删除成功');loadWhitelist();}else{alert(data.msg||'删除失败');}
    }
    // 页面初始化
    window.onload=function(){
      loadShortlinks();
      loadStats();
      loadBlacklist();
      loadWhitelist();
    };
    // 通用弹窗
    function showModal(title,content){
      var modal=document.getElementById('modal');
      modal.innerHTML=`<div style='background:#fff;padding:28px 22px;border-radius:8px;min-width:260px;max-width:90vw;box-shadow:0 2px 16px rgba(0,0,0,0.12);position:relative;'>
        <div style='font-size:18px;margin-bottom:18px;'>${title}</div>
        <div>${content}</div>
        <button class='btn' style='position:absolute;top:12px;right:12px;background:#e53935;' onclick='closeModal()'>关闭</button>
      </div>`;
      modal.style.display='flex';
    }
    function closeModal(){
      document.getElementById('modal').style.display='none';
    }

function showImportBlacklist(){
  showModal('批量导入黑名单',`<form id='importBlacklistForm' style='display:flex;flex-direction:column;gap:12px;'>
    <textarea class='input' name='items' rows='8' placeholder='每行一个域名或关键词'></textarea>
    <input type='file' id='importBlacklistFile' accept='.txt,.csv' style='margin-bottom:8px;'>
    <div style='display:flex;gap:12px;justify-content:flex-end;'>
      <button class='btn' type='submit'>导入</button>
      <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
    </div>
  </form>`);
  setTimeout(()=>{
    const fileInput = document.getElementById('importBlacklistFile');
    if(fileInput){
      fileInput.onchange = function(e){
        const file = e.target.files[0];
        if(file){
          const reader = new FileReader();
          reader.onload = function(evt){
            document.querySelector('#importBlacklistForm textarea').value = evt.target.result;
          };
          reader.readAsText(file);
        }
      };
    }
    const form = document.getElementById('importBlacklistForm');
    if(form){
      form.onsubmit = async function(e){
        e.preventDefault();
        const items = form.items.value.trim().split(/\r?\n/).filter(Boolean);
        if(!items.length){alert('请输入或上传内容');return;}
        const token = localStorage.getItem('admin_token') || '';
        const res = await fetch('/admin/api/blacklist/batch', {method:'POST',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify({items})});
        const data = await res.json();
        if(data.status===0){alert('批量导入成功');closeModal();loadBlacklist();}else{alert(data.msg||'导入失败');}
      };
    }
  },100);
}
function exportBlacklist(){
  const token = localStorage.getItem('admin_token') || '';
  fetch('/admin/api/blacklist', {headers: {Authorization: token}}).then(r=>r.json()).then(resp=>{
    if(resp && resp.status===1 && Array.isArray(resp.data)){
      const content = resp.data.map(i=>i.value).join('\n');
      const blob = new Blob([content],{type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'blacklist.txt';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
    }else{alert(resp.msg||'导出失败');}
  });
}
function showImportWhitelist(){
  showModal('批量导入白名单',`<form id='importWhitelistForm' style='display:flex;flex-direction:column;gap:12px;'>
    <textarea class='input' name='items' rows='8' placeholder='每行一个域名'></textarea>
    <input type='file' id='importWhitelistFile' accept='.txt,.csv' style='margin-bottom:8px;'>
    <div style='display:flex;gap:12px;justify-content:flex-end;'>
      <button class='btn' type='submit'>导入</button>
      <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
    </div>
  </form>`);
  setTimeout(()=>{
    const fileInput = document.getElementById('importWhitelistFile');
    if(fileInput){
      fileInput.onchange = function(e){
        const file = e.target.files[0];
        if(file){
          const reader = new FileReader();
          reader.onload = function(evt){
            document.querySelector('#importWhitelistForm textarea').value = evt.target.result;
          };
          reader.readAsText(file);
        }
      };
    }
    const form = document.getElementById('importWhitelistForm');
    if(form){
      form.onsubmit = async function(e){
        e.preventDefault();
        const items = form.items.value.trim().split(/\r?\n/).filter(Boolean);
        if(!items.length){alert('请输入或上传内容');return;}
        const token = localStorage.getItem('admin_token') || '';
        const res = await fetch('/admin/api/whitelist/batch', {method:'POST',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify({items})});
        const data = await res.json();
        if(data.status===0){alert('批量导入成功');closeModal();loadWhitelist();}else{alert(data.msg||'导入失败');}
      };
    }
  },100);
}
function exportWhitelist(){
  const token = localStorage.getItem('admin_token') || '';
  fetch('/admin/api/whitelist', {headers: {Authorization: token}}).then(r=>r.json()).then(resp=>{
    if(resp && resp.status===1 && Array.isArray(resp.data)){
      const content = resp.data.map(i=>i.value).join('\n');
      const blob = new Blob([content],{type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'whitelist.txt';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
    }else{alert(resp.msg||'导出失败');}
  });
}
function exportStats(){
  const token = localStorage.getItem('admin_token') || '';
  fetch('/admin/api/stats', {headers: {Authorization: token}}).then(r=>r.json()).then(resp=>{
    if(resp && resp.status===1 && Array.isArray(resp.stats)){
      let csv = '短链,访问量,最后访问\n';
      resp.stats.forEach(i=>{
        csv += `${i.code},${i.visits||0},${i.lastVisit?new Date(i.lastVisit).toLocaleString():''}\n`;
      });
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stats.csv';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
    }else{alert(resp.msg||'导出失败');}
  });
}
function editBlacklist(value, item){
  showModal('编辑黑名单',`<form id='editBlacklistForm'>
    <div class='form-group'><label>域名/关键词</label><input class='input' name='item' required value='${item.value}'></div>
    <button class='btn' type='submit'>保存</button>
    <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
  </form>`);
  document.getElementById('editBlacklistForm').onsubmit=async function(e){
    e.preventDefault();
    const token = localStorage.getItem('admin_token') || '';
    const form = e.target;
    const body = {item: form.item.value};
    const res = await fetch('/admin/api/blacklist/'+encodeURIComponent(value), {method:'PUT',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify(body)});
    const data = await res.json();
    if(data.status===0){alert('修改成功');closeModal();loadBlacklist();}else{alert(data.msg||'修改失败');}
  };
}
async function loadAdminLogs(page=1) {
  const startDate = document.getElementById('logStartDate') ? document.getElementById('logStartDate').value : '';
  const endDate = document.getElementById('logEndDate') ? document.getElementById('logEndDate').value : '';
  const type = document.getElementById('logType') ? document.getElementById('logType').value : '';
  const token = localStorage.getItem('admin_token') || '';
  let params = [];
  if(startDate) params.push('startDate='+encodeURIComponent(startDate));
  if(endDate) params.push('endDate='+encodeURIComponent(endDate));
  if(type) params.push('type='+encodeURIComponent(type));
  params.push('page='+page);
  const query = params.length ? '?' + params.join('&') : '';
  const res = await fetch(`/admin/api/logs${query}`, {headers: {Authorization: token}});
  const data = await res.json();
  const logs = Array.isArray(data.data) ? data.data : [];
  const total = typeof data.total === 'number' ? data.total : logs.length;
  const pageSize = typeof data.pageSize === 'number' ? data.pageSize : 50;
  const pageCount = Math.ceil(total / pageSize);
  const tbody = document.querySelector('#logTable tbody');
  tbody.innerHTML = '';
  if(logs.length === 0){
    document.getElementById('logEmpty').style.display = 'block';
    tbody.innerHTML = '';
  }else{
    document.getElementById('logEmpty').style.display = 'none';
    for(const log of logs){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(log.time).toLocaleString()}</td><td>${log.action}</td><td>${log.detail}</td><td>${log.user||''}</td><td>${log.ip||''}</td>`;
      tbody.appendChild(tr);
    }
  }
  // 分页按钮
  let pager = '';
  for(let i=1;i<=pageCount;i++){
    pager += `<button class='btn' style='margin:0 2px;background:${i===page?'#1976d2':'#e5e7eb'};color:${i===page?'#fff':'#333'};' onclick='loadAdminLogs(${i})'>${i}</button>`;
  }
  document.getElementById('logPager').innerHTML = pager;
}
function editWhitelist(value, item){
  showModal('编辑白名单',`<form id='editWhitelistForm'>
    <div class='form-group'><label>域名</label><input class='input' name='item' required value='${item.value}'></div>
    <button class='btn' type='submit'>保存</button>
    <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
  </form>`);
  document.getElementById('editWhitelistForm').onsubmit=async function(e){
    e.preventDefault();
    const token = localStorage.getItem('admin_token') || '';
    const form = e.target;
    const body = {item: form.item.value};
    const res = await fetch('/admin/api/whitelist/'+encodeURIComponent(value), {method:'PUT',headers:{'Content-Type':'application/json',Authorization:token},body:JSON.stringify(body)});
    const data = await res.json();
    if(data.status===0){alert('修改成功');closeModal();loadWhitelist();}else{alert(data.msg||'修改失败');}
  };
}

function formatExpire(ts){
  if(!ts) return '--';
  const d = new Date(ts);
  return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}
   // 初始化
   if(document.getElementById('section-friendlink'))loadFriendLinks();
   if(document.getElementById('section-setting'))loadCopyright();

   // 友情链接管理
   var friendLinks = [];
   async function loadFriendLinks(){
     const token = localStorage.getItem('admin_token') || '';
     fetch('/admin/api/friendlink', {headers: {Authorization: token}})
       .then(res => res.json())
       .then(resp => {
         let data = [];
         if(resp && resp.status === 1 && Array.isArray(resp.data)){
           data = resp.data;
         }
         const tbody = document.querySelector('#friendlinkTable tbody');
         tbody.innerHTML = '';
         if(data && data.length){
           data.forEach((l,i)=>{
             const tr = document.createElement('tr');
             tr.innerHTML = `<td>${l.name}</td><td>${l.url}</td><td class='actions'><button class='btn' onclick='editFriendLink(${i})'>编辑</button><button class='btn' style='background:#e53935;' onclick='deleteFriendLink(${i})'>删除</button></td>`;
             tbody.appendChild(tr);
           });
           document.getElementById('friendlinkEmpty').style.display='none';
         }else{
           document.getElementById('friendlinkEmpty').style.display='block';
         }
         friendLinks = data;
         window._friendLinks = data;
       });
   }
   function showAddFriendLink(){
     showModal('新增友情链接',`<form id='addFriendLinkForm' style='display:flex;flex-direction:column;gap:16px;'>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>名称 <span style='color:#e53935;'>*</span></label>
          <input class='input' name='name' required placeholder='请输入名称'>
        </div>
        <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
          <label>URL <span style='color:#e53935;'>*</span></label>
          <input class='input' name='url' required placeholder='请输入URL'>
        </div>
        <div style='display:flex;gap:12px;justify-content:flex-end;margin-top:8px;'>
          <button class='btn' type='submit' style='min-width:80px;'>提交</button>
          <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
        </div>
      </form>`);
     setTimeout(()=>{
       const form = document.getElementById('addFriendLinkForm');
       if(form){
         form.onsubmit = function(e){
           e.preventDefault();
           const btn = form.querySelector('button[type="submit"]');
           btn.disabled = true;
           btn.textContent = '提交中...';
           const name = form.name.value.trim();
           const url = form.url.value.trim();
           if(!name){alert('请输入名称');btn.disabled=false;btn.textContent='提交';return;}
           if(!url){alert('请输入URL');btn.disabled=false;btn.textContent='提交';return;}
           const token = localStorage.getItem('admin_token') || '';
           fetch('/admin/api/friendlink', {
             method: 'POST',
             headers: {
               'Content-Type': 'application/json',
               'Authorization': token
             },
             body: JSON.stringify({name, url})
           }).then(res => res.json()).then(resp => {
             if (resp && resp.status === 1) {
               alert('添加成功');
               loadFriendLinks();
               closeModal();
             } else {
               alert(resp.msg || '添加失败');
             }
           }).catch(() => alert('请求失败')).finally(()=>{btn.disabled=false;btn.textContent='提交';});
         };
       }
     },100);
   }
   function editFriendLink(idx){
     const link = friendLinks[idx];
     if(!link){alert('未找到该友情链接');return;}
     showModal('编辑友情链接', `
       <form id='editFriendLinkForm' style='display:flex;flex-direction:column;gap:16px;'>
         <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
           <label>名称 <span style='color:#e53935;'>*</span></label>
           <input class='input' name='newName' required placeholder='请输入名称' value='${link.name||""}'>
         </div>
         <div class='form-group' style='display:flex;flex-direction:column;align-items:flex-start;'>
           <label>URL <span style='color:#e53935;'>*</span></label>
           <input class='input' name='newUrl' required placeholder='请输入URL' value='${link.url||""}'>
         </div>
         <input type='hidden' name='oldName' value='${link.name||""}'>
         <input type='hidden' name='oldUrl' value='${link.url||""}'>
         <div style='display:flex;gap:12px;justify-content:flex-end;margin-top:8px;'>
           <button class='btn' type='submit' style='min-width:80px;'>保存</button>
           <button class='btn' type='button' style='background:#888;' onclick='closeModal()'>取消</button>
         </div>
       </form>
     `);
     setTimeout(()=>{
       const form = document.getElementById('editFriendLinkForm');
       if(form){
         form.onsubmit = function(e){
           e.preventDefault();
           const btn = form.querySelector('button[type="submit"]');
           btn.disabled = true;
           btn.textContent = '保存中...';
           const newName = form.newName.value.trim();
           const newUrl = form.newUrl.value.trim();
           const oldName = form.oldName.value;
           const oldUrl = form.oldUrl.value;
           if(!newName){alert('请输入名称');btn.disabled=false;btn.textContent='保存';return;}
           if(!newUrl){alert('请输入URL');btn.disabled=false;btn.textContent='保存';return;}
           const token = localStorage.getItem('admin_token') || '';
           fetch('/admin/api/friendlink', {
             method: 'PUT',
             headers: {
               'Content-Type': 'application/json',
               'Authorization': token
             },
             body: JSON.stringify({oldName, oldUrl, newName, newUrl})
           }).then(res => res.json()).then(resp => {
             if (resp && resp.status === 1) {
               alert('修改成功');
               closeModal();
               loadFriendLinks();
             } else {
               alert(resp.msg || '修改失败');
             }
             btn.disabled = false;
             btn.textContent = '保存';
           }).catch(() => {alert('请求失败');btn.disabled=false;btn.textContent='保存';});
         };
       }
     },100);
   }
   function deleteFriendLink(idx){
     const link = friendLinks[idx];
     if(!link){alert('未找到该友情链接');return;}
     if(!confirm('确定要删除该友情链接吗？'))return;
     const token = localStorage.getItem('admin_token') || '';
     fetch('/admin/api/friendlink/' + encodeURIComponent(link.name), {
       method: 'DELETE',
       headers: {
         'Authorization': token
       }
     }).then(res => res.json()).then(resp => {
       if (resp && resp.status === 1) {
         alert('删除成功');
         loadFriendLinks();
       } else {
         alert(resp.msg || '删除失败');
       }
     }).catch(() => alert('请求失败'));
   }
   // 系统设置
   function loadCopyright(){
     const token = localStorage.getItem('admin_token') || '';
     fetch('/admin/api/setting/copyright', {headers: {Authorization: token}})
       .then(res => res.json()).then(data => {
       document.getElementById('copyrightInput').value = data.data?.copyright||'';
     });
   }
   function saveCopyright(){
     const token = localStorage.getItem('admin_token') || '';
     const copyright = document.getElementById('copyrightInput').value.trim();
     fetch('/admin/api/setting/copyright', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
         'Authorization': token
       },
       body: JSON.stringify({ copyright })
     }).then(res => res.json()).then(resp => {
       if (resp && resp.status === 1) {
         alert('保存成功');
       } else {
         alert(resp.msg || '保存失败');
       }
     }).catch(() => alert('请求失败'));
   }
document.addEventListener('DOMContentLoaded', function() {
  fetch('/admin/api/setting/copyright')
    .then(function(res){ return res.json(); })
    .then(function(data){
      if(data && data.status===1 && typeof data.data === 'string') {
        var input = document.getElementById('copyrightInput');
        if(input) input.value = data.data;
      }
    });
});
// 添加全部清除操作日志功能
async function clearAllAdminLogs() {
  if(!confirm('确定要清除全部操作日志吗？此操作不可恢复！')) return;
  const token = localStorage.getItem('admin_token') || '';
  const res = await fetch('/admin/api/logs/clear', {method:'POST',headers:{Authorization:token}});
  const data = await res.json();
  if(data.status===1){
    alert('操作日志已全部清除！');
    loadAdminLogs();
  }else{
    alert(data.msg||'清除失败');
  }
}

</script>
</body>
</html>
